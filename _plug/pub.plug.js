var mod=(()=>{var C=Object.defineProperty;var X=Object.getOwnPropertyDescriptor;var _=Object.getOwnPropertyNames;var z=Object.prototype.hasOwnProperty;var f=(e,t)=>{for(var r in t)C(e,r,{get:t[r],enumerable:!0})},J=(e,t,r,o)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of _(t))!z.call(e,s)&&s!==r&&C(e,s,{get:()=>t[s],enumerable:!(o=X(t,s))||o.enumerable});return e};var Z=e=>J(C({},"__esModule",{value:!0}),e);var vt={};f(vt,{functionMapping:()=>Y});typeof Deno>"u"&&(self.Deno={args:[],build:{arch:"x86_64"},env:{get(){}}});var E=new Map,k=0;function w(e){self.postMessage(e)}self.syscall=async(e,...t)=>await new Promise((r,o)=>{k++,E.set(k,{resolve:r,reject:o}),w({type:"sys",id:k,name:e,args:t})});function j(e,t){self.addEventListener("message",r=>{(async()=>{let o=r.data;switch(o.type){case"inv":{let s=e[o.name];if(!s)throw new Error(`Function not loaded: ${o.name}`);try{let i=await Promise.resolve(s(...o.args||[]));w({type:"invr",id:o.id,result:i})}catch(i){console.error("An exception was thrown as a result of invoking function",o.name,"error:",i),w({type:"invr",id:o.id,error:i.message})}}break;case"sysr":{let s=o.id,i=E.get(s);if(!i)throw Error("Invalid request id");E.delete(s),o.error?i.reject(new Error(o.error)):i.resolve(o.result)}break}})().catch(console.error)}),w({type:"manifest",manifest:t})}function ee(e){let t=atob(e),r=t.length,o=new Uint8Array(r);for(let s=0;s<r;s++)o[s]=t.charCodeAt(s);return o}function B(e){typeof e=="string"&&(e=new TextEncoder().encode(e));let t="",r=e.byteLength;for(let o=0;o<r;o++)t+=String.fromCharCode(e[o]);return btoa(t)}async function te(e,t){if(typeof e!="string"){let r=new Uint8Array(await e.arrayBuffer()),o=r.length>0?B(r):void 0;t={method:e.method,headers:Object.fromEntries(e.headers.entries()),base64Body:o},e=e.url}return syscall("sandboxFetch.fetch",e,t)}function re(){globalThis.nativeFetch=globalThis.fetch,globalThis.fetch=async function(e,t){let r=t&&t.body?B(new Uint8Array(await new Response(t.body).arrayBuffer())):void 0,o=await te(e,t&&{method:t.method,headers:t.headers,base64Body:r});return new Response(o.base64Body?ee(o.base64Body):null,{status:o.status,headers:o.headers})}}re();var g={};f(g,{confirm:()=>Se,dispatch:()=>Fe,downloadFile:()=>pe,filterBox:()=>ye,flashNotification:()=>he,fold:()=>Ee,foldAll:()=>Ne,getCurrentPage:()=>ne,getCursor:()=>se,getSelection:()=>ae,getText:()=>ie,getUiOption:()=>Me,hidePanel:()=>Pe,insertAtCursor:()=>ve,insertAtPos:()=>be,moveCursor:()=>Te,navigate:()=>ue,openUrl:()=>me,prompt:()=>Ae,reloadPage:()=>de,reloadUI:()=>fe,replaceRange:()=>we,save:()=>le,setPage:()=>oe,setSelection:()=>ce,setUiOption:()=>Ce,showPanel:()=>xe,toggleFold:()=>$e,unfold:()=>Ue,unfoldAll:()=>Oe,uploadFile:()=>ge,vimEx:()=>ke});typeof self>"u"&&(self={syscall:()=>{throw new Error("Not implemented here")}});var n=self.syscall;function ne(){return n("editor.getCurrentPage")}function oe(e){return n("editor.setPage",e)}function ie(){return n("editor.getText")}function se(){return n("editor.getCursor")}function ae(){return n("editor.getSelection")}function ce(e,t){return n("editor.setSelection",e,t)}function le(){return n("editor.save")}function ue(e,t,r=!1,o=!1){return n("editor.navigate",e,t,r,o)}function de(){return n("editor.reloadPage")}function fe(){return n("editor.reloadUI")}function me(e,t=!1){return n("editor.openUrl",e,t)}function pe(e,t){return n("editor.downloadFile",e,t)}function ge(e,t){return n("editor.uploadFile",e,t)}function he(e,t="info"){return n("editor.flashNotification",e,t)}function ye(e,t,r="",o=""){return n("editor.filterBox",e,t,r,o)}function xe(e,t,r,o=""){return n("editor.showPanel",e,t,r,o)}function Pe(e){return n("editor.hidePanel",e)}function be(e,t){return n("editor.insertAtPos",e,t)}function we(e,t,r){return n("editor.replaceRange",e,t,r)}function Te(e,t=!1){return n("editor.moveCursor",e,t)}function ve(e){return n("editor.insertAtCursor",e)}function Fe(e){return n("editor.dispatch",e)}function Ae(e,t=""){return n("editor.prompt",e,t)}function Se(e){return n("editor.confirm",e)}function Me(e){return n("editor.getUiOption",e)}function Ce(e,t){return n("editor.setUiOption",e,t)}function ke(e){return n("editor.vimEx",e)}function Ee(){return n("editor.fold")}function Ue(){return n("editor.unfold")}function $e(){return n("editor.toggleFold")}function Ne(){return n("editor.foldAll")}function Oe(){return n("editor.unfoldAll")}var h={};f(h,{parseMarkdown:()=>Re});function Re(e){return n("markdown.parseMarkdown",e)}var c={};f(c,{deleteAttachment:()=>Ve,deleteFile:()=>ze,deletePage:()=>De,getAttachmentMeta:()=>Ie,getFileMeta:()=>Xe,getPageMeta:()=>je,listAttachments:()=>We,listFiles:()=>Ye,listPages:()=>Ke,listPlugs:()=>Le,readAttachment:()=>Ge,readFile:()=>He,readPage:()=>Be,writeAttachment:()=>Qe,writeFile:()=>_e,writePage:()=>qe});function Ke(e=!1){return n("space.listPages",e)}function je(e){return n("space.getPageMeta",e)}function Be(e){return n("space.readPage",e)}function qe(e,t){return n("space.writePage",e,t)}function De(e){return n("space.deletePage",e)}function Le(){return n("space.listPlugs")}function We(){return n("space.listAttachments")}function Ie(e){return n("space.getAttachmentMeta",e)}function Ge(e){return n("space.readAttachment",e)}function Qe(e,t){return n("space.writeAttachment",e,t)}function Ve(e){return n("space.deleteAttachment",e)}function Ye(){return n("space.listFiles")}function He(e){return n("space.readFile",e)}function Xe(e){return n("space.getFileMeta",e)}function _e(e,t){return n("space.writeFile",e,t)}function ze(e){return n("space.deleteFile",e)}var P={};f(P,{getEnv:()=>tt,invokeCommand:()=>Je,invokeFunction:()=>U,listCommands:()=>Ze,reloadPlugs:()=>et});function U(e,...t){return n("system.invokeFunction",e,...t)}function Je(e,t){return n("system.invokeCommand",e,t)}function Ze(){return n("system.listCommands")}function et(){n("system.reloadPlugs")}function tt(){return n("system.getEnv")}var T={};f(T,{hasInitialSyncCompleted:()=>ot,isSyncing:()=>nt,scheduleFileSync:()=>it,scheduleSpaceSync:()=>st});function nt(){return n("sync.isSyncing")}function ot(){return n("sync.hasInitialSyncCompleted")}function it(e){return n("sync.scheduleFileSync",e)}function st(){return n("sync.scheduleSpaceSync")}var v={};f(v,{renderTemplate:()=>lt});function lt(e,t,r={}){return n("handlebars.renderTemplate",e,t,r)}var m=globalThis.syscall;var b={};f(b,{parse:()=>pt,stringify:()=>gt});function pt(e){return m("yaml.parse",e)}function gt(e){return m("yaml.stringify",e)}function q(e,t){return F(e,r=>r.type===t)}function F(e,t){if(t(e))return[e];let r=[];if(e.children)for(let o of e.children)r=[...r,...F(o,t)];return r}function $(e,t){if(e.children){let r=e.children.slice();for(let o of r){let s=t(o);if(s!==void 0){let i=e.children.indexOf(o);s?e.children.splice(i,1,s):e.children.splice(i,1)}else $(o,t)}}}function N(e,t){return F(e,r=>r.type===t)[0]}function D(e,t){F(e,t)}function O(e){let t=[];if(e.text!==void 0)return e.text;for(let r of e.children)t.push(O(r));return t.join("")}async function R(e,t){let r=await c.readPage(e),o=await h.parseMarkdown(r),s;return D(o,i=>{if(i.type!=="FencedCode")return!1;let u=N(i,"CodeInfo");if(t&&!u||t&&!t.includes(u.children[0].text))return!1;let d=N(i,"CodeText");return d?(s=d.children[0].text,!0):!1}),s}async function A(e,t=["yaml"]){let r=await R(e,t);if(r!==void 0)try{return b.parse(r)}catch(o){throw console.error("YAML Page parser error",o),new Error(`YAML Error: ${o.message}`)}}async function L(e){try{let r=(await A("SECRETS",["yaml","secrets"]))[e];if(r===void 0)throw new Error(`No such secret: ${e}`);return r}catch(t){throw t.message==="Not found"?new Error(`No such secret: ${e}`):t}}var xt="SETTINGS";async function W(e,t){try{let o=(await A(xt,["yaml"])||{})[e];return o===void 0?t:o}catch(r){if(r.message==="Not found")return t;throw r}}function I(e,t){return U("index.queryObjects",e,t)}var S=class{constructor(t){this.prefix=t}async listFiles(){return(await c.listFiles()).filter(t=>t.name.startsWith(this.prefix)).map(t=>({...t,name:t.name.slice(this.prefix.length)}))}readFile(t){return c.readFile(this.prefix+t)}getFileMeta(t){return c.getFileMeta(this.prefix+t)}writeFile(t,r){return c.writeFile(this.prefix+t,r)}deleteFile(t){return c.deleteFile(this.prefix+t)}};var M=class{constructor(t,r){this.url=t;this.token=r}authenticatedFetch(t,r){return nativeFetch(t,{...r,headers:{...r?.headers,"X-Sync-Mode":"true",Authorization:`Bearer ${this.token}`}})}async listFiles(){return(await this.authenticatedFetch(`${this.url}/index.json`,{method:"GET"})).json()}async readFile(t){let r=await this.authenticatedFetch(`${this.url}/${t}`,{method:"GET"});return new Uint8Array(await r.arrayBuffer())}async getFileMeta(t){let r=await this.authenticatedFetch(`${this.url}/${t}`,{method:"GET",headers:{"X-Get-Meta":"true"}});return this.headersToFileMeta(t,r.headers)}async writeFile(t,r){let o=await this.authenticatedFetch(`${this.url}/${t}`,{method:"PUT",body:r});if(o.ok)return this.headersToFileMeta(t,o.headers);throw new Error(`Failed to write file: ${await o.text()}`)}async deleteFile(t){let r=await this.authenticatedFetch(`${this.url}/${t}`,{method:"DELETE"});if(!r.ok)throw new Error(`Failed to delete file: ${await r.text()}`)}headersToFileMeta(t,r){return{name:t,contentType:r.get("Content-Type")||"application/octet-stream",perm:r.get("X-Perm"),created:+(r.get("X-Created")||"0"),lastModified:+(r.get("X-Last-Modified")||"0"),size:r.has("X-Content-Length")?+r.get("X-Content-Length"):+r.get("Content-Length")}}};var G={removeHashtags:!0,template:"!pub.silverbullet.md/template/page",destPrefix:"_public/"};async function Q(e,t,r,o,s,i,u){let d=await c.readPage(t);console.log("Writing",t);let y=await h.parseMarkdown(d),a=await wt(y,i,s,t),l=bt(y);for(let p of l)try{let x=await c.readAttachment(p);console.log("Writing",p),await e.writeFile(p,x)}catch(x){console.error("Error reading attachment",p,x.message)}await e.writeFile(o,new TextEncoder().encode(a)),await e.writeFile(r,new TextEncoder().encode(await v.renderTemplate(u,{pageName:t,config:i,isIndex:t===i.indexPage,body:await P.invokeFunction("markdown.markdownToHtml",a,{smartHardBreak:!0,attachmentUrlPrefix:"/"})},{})))}async function K(){let e=G;try{let a=await W("publish",{});if(e={...G,...a},e.publishServer)try{let l=await L("publish");e.publishToken=l.token}catch(l){console.error("No publish secret found",l)}}catch(a){console.warn("No SETTINGS page found, using defaults",a.message)}let t=e.destPrefix;if(e.publishServer&&!e.publishToken)throw new Error("publishServer specified, but no matching 'token' under 'publish' found in SECRETS");let r=e.publishServer?new M(e.publishServer,e.publishToken):new S(t);console.log("Publishing to",r);let o=await I("page",{}),s=new Map(o.map(a=>[a.name,a]));console.log("Cleaning up destination directory");for(let a of await r.listFiles())await r.deleteFile(a.name);o=[...s.values()];let i=new Set;if(e.publishAll)i=new Set(o.map(a=>a.name));else for(let a of o){if(e.tags&&a.tags)for(let l of a.tags)e.tags.includes(l)&&i.add(a.name);if(typeof a.name=="string"){if(e.prefixes)for(let l of e.prefixes)a.name.startsWith(l)&&i.add(a.name);a.$share&&(Array.isArray(a.$share)||(a.$share=[a.$share]),a.$share.includes("pub")&&i.add(a.name))}}console.log("Publishing",[...i]);let u=await R(e.template),d=[...i];for(let a of d)await Q(r,a,`${a}/index.html`,`${a}.md`,d,e,u);e.indexPage&&(console.log("Writing",e.indexPage),await Q(r,e.indexPage,"index.html","index.md",d,e,u)),console.log("Writing","index.json");let y=[];for(let{name:a,size:l,contentType:p,lastModified:x,created:H}of await c.listAttachments())if(a.startsWith(t)){if(p==="text/html")continue;y.push({name:a.slice(t.length),size:l,contentType:p,lastModified:x,created:H,perm:"ro"})}await r.writeFile("index.json",new TextEncoder().encode(JSON.stringify(y,null,2)))}async function V(){await g.flashNotification("Publishing..."),await K(),await T.scheduleSpaceSync(),await g.flashNotification("Done!")}function bt(e){let t=[];return q(e,"URL").forEach(r=>{let o=r.children[0].text;o.indexOf("://")===-1&&t.push(o)}),t}async function wt(e,t,r,o){return $(e,s=>{if(s.type==="WikiLink"){let i=s.children[1].children[0].text;if(i.includes("@")&&(i=i.split("@")[0]),i.startsWith("!"))return{text:`[${i.split("/").pop()}](https://${i.slice(1)})`};if(!r.includes(i)&&!i.startsWith("!"))return{text:`_${i}_`}}if(s.type==="CommentBlock"||s.type==="Comment"||s.type==="Hashtag"&&t.removeHashtags)return null}),e=await P.invokeFunction("markdown.expandCodeWidgets",e,o),O(e).trim()}var Y={publishAll:K,publishAllCommand:V},Tt={name:"pub",functions:{publishAll:{path:"./publish.ts:publishAll"},publishAllCommand:{path:"./publish.ts:publishAllCommand",command:{name:"Pub: Publish All"}}},assets:{}};j(Y,Tt);return Z(vt);})();
