var mod=(()=>{var C=Object.defineProperty;var H=Object.getOwnPropertyDescriptor;var X=Object.getOwnPropertyNames;var _=Object.prototype.hasOwnProperty;var d=(e,t)=>{for(var r in t)C(e,r,{get:t[r],enumerable:!0})},z=(e,t,r,o)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of X(t))!_.call(e,i)&&i!==r&&C(e,i,{get:()=>t[i],enumerable:!(o=H(t,i))||o.enumerable});return e};var J=e=>z(C({},"__esModule",{value:!0}),e);var Tt={};d(Tt,{functionMapping:()=>Y});typeof Deno>"u"&&(self.Deno={args:[],build:{arch:"x86_64"},env:{get(){}}});var k=new Map,E=0;function b(e){self.postMessage(e)}self.syscall=async(e,...t)=>await new Promise((r,o)=>{E++,k.set(E,{resolve:r,reject:o}),b({type:"sys",id:E,name:e,args:t})});function j(e,t){self.addEventListener("message",r=>{(async()=>{let o=r.data;switch(o.type){case"inv":{let i=e[o.name];if(!i)throw new Error(`Function not loaded: ${o.name}`);try{let a=await Promise.resolve(i(...o.args||[]));b({type:"invr",id:o.id,result:a})}catch(a){console.error("An exception was thrown as a result of invoking function",o.name,"error:",a),b({type:"invr",id:o.id,error:a.message})}}break;case"sysr":{let i=o.id,a=k.get(i);if(!a)throw Error("Invalid request id");k.delete(i),o.error?a.reject(new Error(o.error)):a.resolve(o.result)}break}})().catch(console.error)}),b({type:"manifest",manifest:t})}function Z(e){let t=atob(e),r=t.length,o=new Uint8Array(r);for(let i=0;i<r;i++)o[i]=t.charCodeAt(i);return o}function B(e){typeof e=="string"&&(e=new TextEncoder().encode(e));let t="",r=e.byteLength;for(let o=0;o<r;o++)t+=String.fromCharCode(e[o]);return btoa(t)}async function ee(e,t){if(typeof e!="string"){let r=new Uint8Array(await e.arrayBuffer()),o=r.length>0?B(r):void 0;t={method:e.method,headers:Object.fromEntries(e.headers.entries()),base64Body:o},e=e.url}return syscall("sandboxFetch.fetch",e,t)}function te(){globalThis.nativeFetch=globalThis.fetch,globalThis.fetch=async function(e,t){let r=t&&t.body?B(new Uint8Array(await new Response(t.body).arrayBuffer())):void 0,o=await ee(e,t&&{method:t.method,headers:t.headers,base64Body:r});return new Response(o.base64Body?Z(o.base64Body):null,{status:o.status,headers:o.headers})}}te();var g={};d(g,{confirm:()=>Ae,dispatch:()=>ve,downloadFile:()=>me,filterBox:()=>he,flashNotification:()=>ge,fold:()=>Ee,foldAll:()=>$e,getCurrentPage:()=>re,getCursor:()=>ie,getSelection:()=>se,getText:()=>oe,getUiOption:()=>Se,hidePanel:()=>xe,insertAtCursor:()=>Te,insertAtPos:()=>Pe,moveCursor:()=>we,navigate:()=>ce,openUrl:()=>fe,prompt:()=>Fe,reloadPage:()=>ue,reloadUI:()=>de,replaceRange:()=>be,save:()=>le,setPage:()=>ne,setSelection:()=>ae,setUiOption:()=>Me,showPanel:()=>ye,toggleFold:()=>Ue,unfold:()=>ke,unfoldAll:()=>Ne,uploadFile:()=>pe,vimEx:()=>Ce});typeof self>"u"&&(self={syscall:()=>{throw new Error("Not implemented here")}});var n=self.syscall;function re(){return n("editor.getCurrentPage")}function ne(e){return n("editor.setPage",e)}function oe(){return n("editor.getText")}function ie(){return n("editor.getCursor")}function se(){return n("editor.getSelection")}function ae(e,t){return n("editor.setSelection",e,t)}function le(){return n("editor.save")}function ce(e,t,r=!1,o=!1){return n("editor.navigate",e,t,r,o)}function ue(){return n("editor.reloadPage")}function de(){return n("editor.reloadUI")}function fe(e,t=!1){return n("editor.openUrl",e,t)}function me(e,t){return n("editor.downloadFile",e,t)}function pe(e,t){return n("editor.uploadFile",e,t)}function ge(e,t="info"){return n("editor.flashNotification",e,t)}function he(e,t,r="",o=""){return n("editor.filterBox",e,t,r,o)}function ye(e,t,r,o=""){return n("editor.showPanel",e,t,r,o)}function xe(e){return n("editor.hidePanel",e)}function Pe(e,t){return n("editor.insertAtPos",e,t)}function be(e,t,r){return n("editor.replaceRange",e,t,r)}function we(e,t=!1){return n("editor.moveCursor",e,t)}function Te(e){return n("editor.insertAtCursor",e)}function ve(e){return n("editor.dispatch",e)}function Fe(e,t=""){return n("editor.prompt",e,t)}function Ae(e){return n("editor.confirm",e)}function Se(e){return n("editor.getUiOption",e)}function Me(e,t){return n("editor.setUiOption",e,t)}function Ce(e){return n("editor.vimEx",e)}function Ee(){return n("editor.fold")}function ke(){return n("editor.unfold")}function Ue(){return n("editor.toggleFold")}function $e(){return n("editor.foldAll")}function Ne(){return n("editor.unfoldAll")}var h={};d(h,{parseMarkdown:()=>Oe});function Oe(e){return n("markdown.parseMarkdown",e)}var l={};d(l,{deleteAttachment:()=>Qe,deleteFile:()=>_e,deletePage:()=>De,getAttachmentMeta:()=>We,getFileMeta:()=>He,getPageMeta:()=>Ke,listAttachments:()=>Le,listFiles:()=>Ve,listPages:()=>Re,listPlugs:()=>qe,readAttachment:()=>Ie,readFile:()=>Ye,readPage:()=>je,writeAttachment:()=>Ge,writeFile:()=>Xe,writePage:()=>Be});function Re(e=!1){return n("space.listPages",e)}function Ke(e){return n("space.getPageMeta",e)}function je(e){return n("space.readPage",e)}function Be(e,t){return n("space.writePage",e,t)}function De(e){return n("space.deletePage",e)}function qe(){return n("space.listPlugs")}function Le(){return n("space.listAttachments")}function We(e){return n("space.getAttachmentMeta",e)}function Ie(e){return n("space.readAttachment",e)}function Ge(e,t){return n("space.writeAttachment",e,t)}function Qe(e){return n("space.deleteAttachment",e)}function Ve(){return n("space.listFiles")}function Ye(e){return n("space.readFile",e)}function He(e){return n("space.getFileMeta",e)}function Xe(e,t){return n("space.writeFile",e,t)}function _e(e){return n("space.deleteFile",e)}var x={};d(x,{getEnv:()=>et,invokeCommand:()=>ze,invokeFunction:()=>U,listCommands:()=>Je,reloadPlugs:()=>Ze});function U(e,...t){return n("system.invokeFunction",e,...t)}function ze(e,t){return n("system.invokeCommand",e,t)}function Je(){return n("system.listCommands")}function Ze(){n("system.reloadPlugs")}function et(){return n("system.getEnv")}var w={};d(w,{hasInitialSyncCompleted:()=>nt,isSyncing:()=>rt,scheduleFileSync:()=>ot,scheduleSpaceSync:()=>it});function rt(){return n("sync.isSyncing")}function nt(){return n("sync.hasInitialSyncCompleted")}function ot(e){return n("sync.scheduleFileSync",e)}function it(){return n("sync.scheduleSpaceSync")}var T={};d(T,{renderTemplate:()=>lt});function lt(e,t,r={}){return n("handlebars.renderTemplate",e,t,r)}var f=globalThis.syscall;var P={};d(P,{parse:()=>mt,stringify:()=>pt});function mt(e){return f("yaml.parse",e)}function pt(e){return f("yaml.stringify",e)}function D(e,t){return v(e,r=>r.type===t)}function v(e,t){if(t(e))return[e];let r=[];if(e.children)for(let o of e.children)r=[...r,...v(o,t)];return r}function $(e,t){if(e.children){let r=e.children.slice();for(let o of r){let i=t(o);if(i!==void 0){let a=e.children.indexOf(o);i?e.children.splice(a,1,i):e.children.splice(a,1)}else $(o,t)}}}function N(e,t){return v(e,r=>r.type===t)[0]}function q(e,t){v(e,t)}function O(e){let t=[];if(e.text!==void 0)return e.text;for(let r of e.children)t.push(O(r));return t.join("")}async function R(e,t){let r=await l.readPage(e),o=await h.parseMarkdown(r),i;return q(o,a=>{if(a.type!=="FencedCode")return!1;let c=N(a,"CodeInfo");if(t&&!c||t&&!t.includes(c.children[0].text))return!1;let m=N(a,"CodeText");return m?(i=m.children[0].text,!0):!1}),i}async function F(e,t=["yaml"]){let r=await R(e,t);if(r!==void 0)try{return P.parse(r)}catch(o){throw console.error("YAML Page parser error",o),new Error(`YAML Error: ${o.message}`)}}async function L(e){try{let r=(await F("SECRETS",["yaml","secrets"]))[e];if(r===void 0)throw new Error(`No such secret: ${e}`);return r}catch(t){throw t.message==="Not found"?new Error(`No such secret: ${e}`):t}}var yt="SETTINGS";async function W(e,t){try{let o=(await F(yt,["yaml"])||{})[e];return o===void 0?t:o}catch(r){if(r.message==="Not found")return t;throw r}}function I(e,t){return U("index.queryObjects",e,t)}var A=class{constructor(t){this.prefix=t}async listFiles(){return(await l.listFiles()).filter(t=>t.name.startsWith(this.prefix)).map(t=>({...t,name:t.name.slice(this.prefix.length)}))}readFile(t){return l.readFile(this.prefix+t)}getFileMeta(t){return l.getFileMeta(this.prefix+t)}writeFile(t,r){return l.writeFile(this.prefix+t,r)}deleteFile(t){return l.deleteFile(this.prefix+t)}};var S=class{constructor(t,r){this.url=t;this.token=r}authenticatedFetch(t,r){return nativeFetch(t,{...r,headers:{...r?.headers,"X-Sync-Mode":"true",Authorization:`Bearer ${this.token}`}})}async listFiles(){let t=await this.authenticatedFetch(`${this.url}/index.json`,{method:"GET"});if(t.status===404)throw new Error("Not found");return t.json()}async readFile(t){let r=await this.authenticatedFetch(`${this.url}/${t}`,{method:"GET"});return new Uint8Array(await r.arrayBuffer())}async getFileMeta(t){let r=await this.authenticatedFetch(`${this.url}/${t}`,{method:"GET",headers:{"X-Get-Meta":"true"}});return this.headersToFileMeta(t,r.headers)}async writeFile(t,r){let o=await this.authenticatedFetch(`${this.url}/${t}`,{method:"PUT",body:r});if(o.ok)return this.headersToFileMeta(t,o.headers);throw new Error(`Failed to write file: ${await o.text()}`)}async deleteFile(t){let r=await this.authenticatedFetch(`${this.url}/${t}`,{method:"DELETE"});if(!r.ok)throw new Error(`Failed to delete file: ${t}: ${await r.text()}`)}headersToFileMeta(t,r){return{name:t,contentType:r.get("Content-Type")||"application/octet-stream",perm:r.get("X-Perm"),created:+(r.get("X-Created")||"0"),lastModified:+(r.get("X-Last-Modified")||"0"),size:r.has("X-Content-Length")?+r.get("X-Content-Length"):+r.get("Content-Length")}}};var G={removeHashtags:!0,template:"!pub.silverbullet.md/template/page",destPrefix:"_public/"};async function Q(e,t,r,o,i,a,c){console.log("Writing",t);let m=await l.readPage(t),p=await h.parseMarkdown(m),y=await bt(p,a,i,t),s=Pt(p);for(let u of s)try{let M=await l.readAttachment(u);console.log("Writing",u),await e.writeFile(u,M)}catch(M){console.error("Error reading attachment",u,M.message)}await e.writeFile(o,new TextEncoder().encode(y)),await e.writeFile(r,new TextEncoder().encode(await T.renderTemplate(c,{pageName:t,config:a,isIndex:t===a.indexPage,body:await x.invokeFunction("markdown.markdownToHtml",y,{smartHardBreak:!0,attachmentUrlPrefix:"/"})},{})))}async function K(){let e=G;try{let s=await W("publish",{});if(e={...G,...s},e.publishServer)try{let u=await L("publish");e.publishToken=u.token}catch(u){console.error("No publish secret found",u)}}catch(s){console.warn("No SETTINGS page found, using defaults",s.message)}let t=e.destPrefix;if(e.publishServer&&!e.publishToken)throw new Error("publishServer specified, but no matching 'token' under 'publish' found in SECRETS");let r=e.publishServer?new S(e.publishServer,e.publishToken):new A(t);console.log("Publishing to",r);let o=await I("page",{});console.log("All pages",o);let i=new Map(o.map(s=>[s.name,s]));i.delete("SECRETS"),console.log("Cleaning up destination directory");let a=[];try{a=await r.listFiles()}catch(s){s.message==="Not found"&&console.log("Could not fetch file list from remote, assume it has not been initialized yet")}for(let s of a)await r.deleteFile(s.name);o=[...i.values()];let c=new Set;if(e.publishAll)c=new Set(o.map(s=>s.name));else for(let s of o){if(e.tags&&s.tags)for(let u of s.tags)e.tags.includes(u)&&c.add(s.name);if(typeof s.name=="string"){if(e.prefixes)for(let u of e.prefixes)s.name.startsWith(u)&&c.add(s.name);s.$share&&(Array.isArray(s.$share)||(s.$share=[s.$share]),s.$share.includes("pub")&&c.add(s.name))}}console.log("Publishing",[...c]);let m=await R(e.template),p=[...c];for(let s of p)await Q(r,s,`${s}/index.html`,`${s}.md`,p,e,m);console.log("Done writing published paegs"),e.indexPage&&(console.log("Writing index page",e.indexPage),await Q(r,e.indexPage,"index.html","index.md",p,e,m)),console.log("Publishing index.json");let y=[];for(let s of await r.listFiles())s.contentType!=="text/html"&&y.push({...s,perm:"ro"});await r.writeFile("index.json",new TextEncoder().encode(JSON.stringify(y,null,2)))}async function V(){await g.flashNotification("Publishing..."),await K(),await w.scheduleSpaceSync(),await g.flashNotification("Done!")}function Pt(e){let t=[];return D(e,"URL").forEach(r=>{let o=r.children[0].text;o.indexOf("://")===-1&&t.push(o)}),t}async function bt(e,t,r,o){try{e=await x.invokeFunction("markdown.expandCodeWidgets",e,o)}catch(i){console.error("Error expanding code widgets in page",o,i.message)}return $(e,i=>{if(i.type==="WikiLink"){let a=i.children[1].children[0].text;if(a.includes("@")&&(a=a.split("@")[0]),a.startsWith("!"))return{text:`[${a.split("/").pop()}](https://${a.slice(1)})`};if(!r.includes(a)&&!a.startsWith("!"))return{text:`_${a}_`}}if(i.type==="CommentBlock"||i.type==="Comment"||i.type==="Hashtag"&&t.removeHashtags)return null}),O(e).trim()}var Y={publishAll:K,publishAllCommand:V},wt={name:"pub",functions:{publishAll:{path:"./publish.ts:publishAll"},publishAllCommand:{path:"./publish.ts:publishAllCommand",command:{name:"Pub: Publish All"}}},assets:{}};j(Y,wt);return J(Tt);})();
