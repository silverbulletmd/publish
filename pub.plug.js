var J=Object.defineProperty;var f=(e,t)=>{for(var r in t)J(e,r,{get:t[r],enumerable:!0})};var U=typeof window>"u"&&typeof globalThis.WebSocketPair>"u";typeof Deno>"u"&&(self.Deno={args:[],build:{arch:"x86_64"},env:{get(){}}});var k=new Map,E=0;function b(e){self.postMessage(e)}U&&(globalThis.syscall=async(e,...t)=>await new Promise((r,n)=>{E++,k.set(E,{resolve:r,reject:n}),b({type:"sys",id:E,name:e,args:t})}));function L(e,t){U&&(self.addEventListener("message",r=>{(async()=>{let n=r.data;switch(n.type){case"inv":{let s=e[n.name];if(!s)throw new Error(`Function not loaded: ${n.name}`);try{let i=await Promise.resolve(s(...n.args||[]));b({type:"invr",id:n.id,result:i})}catch(i){console.error("An exception was thrown as a result of invoking function",n.name,"error:",i),b({type:"invr",id:n.id,error:i.message})}}break;case"sysr":{let s=n.id,i=k.get(s);if(!i)throw Error("Invalid request id");k.delete(s),n.error?i.reject(new Error(n.error)):i.resolve(n.result)}break}})().catch(console.error)}),b({type:"manifest",manifest:t}))}function Z(e){let t=atob(e),r=t.length,n=new Uint8Array(r);for(let s=0;s<r;s++)n[s]=t.charCodeAt(s);return n}function D(e){typeof e=="string"&&(e=new TextEncoder().encode(e));let t="",r=e.byteLength;for(let n=0;n<r;n++)t+=String.fromCharCode(e[n]);return btoa(t)}async function ee(e,t){if(typeof e!="string"){let r=new Uint8Array(await e.arrayBuffer()),n=r.length>0?D(r):void 0;t={method:e.method,headers:Object.fromEntries(e.headers.entries()),base64Body:n},e=e.url}return syscall("sandboxFetch.fetch",e,t)}globalThis.nativeFetch=globalThis.fetch;function te(){globalThis.fetch=async function(e,t){let r=t&&t.body?D(new Uint8Array(await new Response(t.body).arrayBuffer())):void 0,n=await ee(e,t&&{method:t.method,headers:t.headers,base64Body:r});return new Response(n.base64Body?Z(n.base64Body):null,{status:n.status,headers:n.headers})}}U&&te();var g={};f(g,{confirm:()=>Ce,dispatch:()=>Se,downloadFile:()=>he,filterBox:()=>Pe,flashNotification:()=>xe,fold:()=>Oe,foldAll:()=>Ke,getCurrentPage:()=>re,getCursor:()=>ie,getSelection:()=>se,getText:()=>oe,getUiOption:()=>Ee,hidePanel:()=>we,insertAtCursor:()=>Ae,insertAtPos:()=>Te,moveCursor:()=>Fe,navigate:()=>ce,openCommandPalette:()=>de,openPageNavigator:()=>ue,openUrl:()=>ge,prompt:()=>Me,reloadPage:()=>me,reloadSettingsAndCommands:()=>pe,reloadUI:()=>fe,replaceRange:()=>ve,save:()=>le,setPage:()=>ne,setSelection:()=>ae,setUiOption:()=>ke,showPanel:()=>be,toggleFold:()=>Ne,unfold:()=>$e,unfoldAll:()=>Re,uploadFile:()=>ye,vimEx:()=>Ue});typeof self>"u"&&(self={syscall:()=>{throw new Error("Not implemented here")}});var o=self.syscall;function re(){return o("editor.getCurrentPage")}function ne(e){return o("editor.setPage",e)}function oe(){return o("editor.getText")}function ie(){return o("editor.getCursor")}function se(){return o("editor.getSelection")}function ae(e,t){return o("editor.setSelection",e,t)}function le(){return o("editor.save")}function ce(e,t,r=!1,n=!1){return o("editor.navigate",e,t,r,n)}function ue(e="page"){return o("editor.openPageNavigator",e)}function de(){return o("editor.openCommandPalette")}function me(){return o("editor.reloadPage")}function fe(){return o("editor.reloadUI")}function pe(){return o("editor.reloadSettingsAndCommands")}function ge(e,t=!1){return o("editor.openUrl",e,t)}function he(e,t){return o("editor.downloadFile",e,t)}function ye(e,t){return o("editor.uploadFile",e,t)}function xe(e,t="info"){return o("editor.flashNotification",e,t)}function Pe(e,t,r="",n=""){return o("editor.filterBox",e,t,r,n)}function be(e,t,r,n=""){return o("editor.showPanel",e,t,r,n)}function we(e){return o("editor.hidePanel",e)}function Te(e,t){return o("editor.insertAtPos",e,t)}function ve(e,t,r){return o("editor.replaceRange",e,t,r)}function Fe(e,t=!1){return o("editor.moveCursor",e,t)}function Ae(e){return o("editor.insertAtCursor",e)}function Se(e){return o("editor.dispatch",e)}function Me(e,t=""){return o("editor.prompt",e,t)}function Ce(e){return o("editor.confirm",e)}function Ee(e){return o("editor.getUiOption",e)}function ke(e,t){return o("editor.setUiOption",e,t)}function Ue(e){return o("editor.vimEx",e)}function Oe(){return o("editor.fold")}function $e(){return o("editor.unfold")}function Ne(){return o("editor.toggleFold")}function Ke(){return o("editor.foldAll")}function Re(){return o("editor.unfoldAll")}var h={};f(h,{parseMarkdown:()=>je});function je(e){return o("markdown.parseMarkdown",e)}var l={};f(l,{deleteAttachment:()=>ze,deleteFile:()=>Ze,deletePage:()=>We,getAttachmentMeta:()=>Ge,getFileMeta:()=>_e,getPageMeta:()=>De,listAttachments:()=>Ie,listFiles:()=>He,listPages:()=>Le,listPlugs:()=>qe,readAttachment:()=>Qe,readFile:()=>Xe,readPage:()=>Be,writeAttachment:()=>Ye,writeFile:()=>Je,writePage:()=>Ve});function Le(e=!1){return o("space.listPages",e)}function De(e){return o("space.getPageMeta",e)}function Be(e){return o("space.readPage",e)}function Ve(e,t){return o("space.writePage",e,t)}function We(e){return o("space.deletePage",e)}function qe(){return o("space.listPlugs")}function Ie(){return o("space.listAttachments")}function Ge(e){return o("space.getAttachmentMeta",e)}function Qe(e){return o("space.readAttachment",e)}function Ye(e,t){return o("space.writeAttachment",e,t)}function ze(e){return o("space.deleteAttachment",e)}function He(){return o("space.listFiles")}function Xe(e){return o("space.readFile",e)}function _e(e){return o("space.getFileMeta",e)}function Je(e,t){return o("space.writeFile",e,t)}function Ze(e){return o("space.deleteFile",e)}var x={};f(x,{getEnv:()=>nt,invokeCommand:()=>et,invokeFunction:()=>O,listCommands:()=>tt,reloadPlugs:()=>rt});function O(e,...t){return o("system.invokeFunction",e,...t)}function et(e,t){return o("system.invokeCommand",e,t)}function tt(){return o("system.listCommands")}function rt(){o("system.reloadPlugs")}function nt(){return o("system.getEnv")}var w={};f(w,{hasInitialSyncCompleted:()=>st,isSyncing:()=>it,scheduleFileSync:()=>at,scheduleSpaceSync:()=>lt});function it(){return o("sync.isSyncing")}function st(){return o("sync.hasInitialSyncCompleted")}function at(e){return o("sync.scheduleFileSync",e)}function lt(){return o("sync.scheduleSpaceSync")}var T={};f(T,{renderTemplate:()=>dt});function dt(e,t,r={}){return o("handlebars.renderTemplate",e,t,r)}var d=globalThis.syscall;var P={};f(P,{parse:()=>ht,stringify:()=>yt});function ht(e){return d("yaml.parse",e)}function yt(e){return d("yaml.stringify",e)}function B(e,t){return v(e,r=>r.type===t)}function v(e,t){if(t(e))return[e];let r=[];if(e.children)for(let n of e.children)r=[...r,...v(n,t)];return r}function $(e,t){if(e.children){let r=e.children.slice();for(let n of r){let s=t(n);if(s!==void 0){let i=e.children.indexOf(n);s?e.children.splice(i,1,s):e.children.splice(i,1)}else $(n,t)}}}function N(e,t){return v(e,r=>r.type===t)[0]}function V(e,t){v(e,t)}function K(e){if(!e)return"";let t=[];if(e.text!==void 0)return e.text;for(let r of e.children)t.push(K(r));return t.join("")}async function R(e,t){let r=await l.readPage(e),n=await h.parseMarkdown(r),s;return V(n,i=>{if(i.type!=="FencedCode")return!1;let c=N(i,"CodeInfo");if(t&&!c||t&&!t.includes(c.children[0].text))return!1;let m=N(i,"CodeText");return m?(s=m.children[0].text,!0):!1}),s}async function F(e,t=["yaml"]){let r=await R(e,t);if(r!==void 0)try{return P.parse(r)}catch(n){throw console.error("YAML Page parser error",n),new Error(`YAML Error: ${n.message}`)}}async function W(e){try{let r=(await F("SECRETS",["yaml","secrets"]))[e];if(r===void 0)throw new Error(`No such secret: ${e}`);return r}catch(t){throw t.message==="Not found"?new Error(`No such secret: ${e}`):t}}var bt="SETTINGS";async function q(e,t){try{let n=(await F(bt,["yaml"])||{})[e];return n===void 0?t:n}catch(r){if(r.message==="Not found")return t;throw r}}var A=class{constructor(t,r={}){this.maxSize=t;this.map=new Map(Object.entries(r))}map;set(t,r,n){let s={value:r,la:Date.now()};if(n){let i=this.map.get(t);i?.expTimer&&clearTimeout(i.expTimer),s.expTimer=setTimeout(()=>{this.map.delete(t)},n)}if(this.map.size>=this.maxSize){let i=this.getOldestKey();this.map.delete(i)}this.map.set(t,s)}get(t){let r=this.map.get(t);if(r)return r.la=Date.now(),r.value}remove(t){this.map.delete(t)}toJSON(){return Object.fromEntries(this.map.entries())}getOldestKey(){let t,r;for(let[n,s]of this.map.entries())(!r||s.la<r)&&(t=n,r=s.la);return t}};var I=new A(50);async function G(e,t,r){if(!r)return t(e);let n=JSON.stringify(e),s=I.get(n);if(s)return s;let i=await t(e);return I.set(n,i,r*1e3),i}function Q(e,t,r){return G(t,()=>O("index.queryObjects",e,t),r)}var S=class{constructor(t){this.prefix=t}async listFiles(){return(await l.listFiles()).filter(t=>t.name.startsWith(this.prefix)).map(t=>({...t,name:t.name.slice(this.prefix.length)}))}readFile(t){return l.readFile(this.prefix+t)}getFileMeta(t){return l.getFileMeta(this.prefix+t)}writeFile(t,r){return l.writeFile(this.prefix+t,r)}deleteFile(t){return l.deleteFile(this.prefix+t)}};var M=class{constructor(t,r){this.url=t;this.token=r}authenticatedFetch(t,r){return nativeFetch(t,{...r,headers:{...r?.headers,"X-Sync-Mode":"true",Authorization:`Bearer ${this.token}`}})}async listFiles(){let t=await this.authenticatedFetch(`${this.url}/index.json`,{method:"GET"});if(t.status===404)throw new Error("Not found");return t.json()}async readFile(t){let r=await this.authenticatedFetch(`${this.url}/${t}`,{method:"GET"});return new Uint8Array(await r.arrayBuffer())}async getFileMeta(t){let r=await this.authenticatedFetch(`${this.url}/${t}`,{method:"GET",headers:{"X-Get-Meta":"true"}});return this.headersToFileMeta(t,r.headers)}async writeFile(t,r){let n=await this.authenticatedFetch(`${this.url}/${t}`,{method:"PUT",body:r});if(n.ok)return this.headersToFileMeta(t,n.headers);throw new Error(`Failed to write file: ${await n.text()}`)}async deleteFile(t){let r=await this.authenticatedFetch(`${this.url}/${t}`,{method:"DELETE"});if(!r.ok)throw new Error(`Failed to delete file: ${t}: ${await r.text()}`)}headersToFileMeta(t,r){return{name:t,contentType:r.get("Content-Type")||"application/octet-stream",perm:r.get("X-Perm"),created:+(r.get("X-Created")||"0"),lastModified:+(r.get("X-Last-Modified")||"0"),size:r.has("X-Content-Length")?+r.get("X-Content-Length"):+r.get("Content-Length")}}};var Y={removeHashtags:!0,template:"!pub.silverbullet.md/template/page",destPrefix:"_public/"};async function z(e,t,r,n,s,i,c){console.log("Writing",t);let m=await l.readPage(t),p=await h.parseMarkdown(m),y=await vt(p,i,s,t),a=Tt(p);for(let u of a)try{let C=await l.readAttachment(u);console.log("Writing",u),await e.writeFile(u,C)}catch(C){console.error("Error reading attachment",u,C.message)}await e.writeFile(n,new TextEncoder().encode(y)),await e.writeFile(r,new TextEncoder().encode(await T.renderTemplate(c,{pageName:t,config:i,isIndex:t===i.indexPage,body:await x.invokeFunction("markdown.markdownToHtml",y,{smartHardBreak:!0,attachmentUrlPrefix:"/"})},{})))}async function j(){let e=Y;try{let a=await q("publish",{});if(e={...Y,...a},e.publishServer)try{let u=await W("publish");e.publishToken=u.token}catch(u){console.error("No publish secret found",u)}}catch(a){console.warn("No SETTINGS page found, using defaults",a.message)}let t=e.destPrefix;if(e.publishServer&&!e.publishToken)throw new Error("publishServer specified, but no matching 'token' under 'publish' found in SECRETS");let r=e.publishServer?new M(e.publishServer,e.publishToken):new S(t);console.log("Publishing to",r);let n=await Q("page",{});console.log("All pages",n);let s=new Map(n.map(a=>[a.name,a]));s.delete("SECRETS"),console.log("Cleaning up destination directory");let i=[];try{i=await r.listFiles()}catch(a){a.message==="Not found"&&console.log("Could not fetch file list from remote, assume it has not been initialized yet")}for(let a of i)await r.deleteFile(a.name);n=[...s.values()];let c=new Set;if(e.publishAll)c=new Set(n.map(a=>a.name));else for(let a of n){if(e.tags&&a.tags)for(let u of a.tags)e.tags.includes(u)&&c.add(a.name);if(typeof a.name=="string"){if(e.prefixes)for(let u of e.prefixes)a.name.startsWith(u)&&c.add(a.name);a.$share&&(Array.isArray(a.$share)||(a.$share=[a.$share]),a.$share.includes("pub")&&c.add(a.name))}}console.log("Publishing",[...c]);let m=await R(e.template),p=[...c];for(let a of p)await z(r,a,`${a}/index.html`,`${a}.md`,p,e,m);console.log("Done writing published paegs"),e.indexPage&&(console.log("Writing index page",e.indexPage),await z(r,e.indexPage,"index.html","index.md",p,e,m)),console.log("Publishing index.json");let y=[];for(let a of await r.listFiles())a.contentType!=="text/html"&&y.push({...a,perm:"ro"});await r.writeFile("index.json",new TextEncoder().encode(JSON.stringify(y,null,2)))}async function H(){await g.flashNotification("Publishing..."),await j(),await w.scheduleSpaceSync(),await g.flashNotification("Done!")}function Tt(e){let t=[];return B(e,"URL").forEach(r=>{let n=r.children[0].text;n.indexOf("://")===-1&&t.push(n)}),t}async function vt(e,t,r,n){try{e=await x.invokeFunction("markdown.expandCodeWidgets",e,n)}catch(s){console.error("Error expanding code widgets in page",n,s.message)}return $(e,s=>{if(s.type==="WikiLink"){let i=s.children[1].children[0].text;if(i.includes("@")&&(i=i.split("@")[0]),i.startsWith("!"))return{text:`[${i.split("/").pop()}](https://${i.slice(1)})`};if(!r.includes(i)&&!i.startsWith("!"))return{text:`_${i}_`}}if(s.type==="CommentBlock"||s.type==="Comment"||s.type==="Hashtag"&&t.removeHashtags)return null}),K(e).trim()}var X={publishAll:j,publishAllCommand:H},_={name:"pub",functions:{publishAll:{path:"./publish.ts:publishAll"},publishAllCommand:{path:"./publish.ts:publishAllCommand",command:{name:"Pub: Publish All"}}},assets:{}},kr={manifest:_,functionMapping:X};L(X,_);export{kr as plug};
