var J=Object.defineProperty;var f=(e,t)=>{for(var r in t)J(e,r,{get:t[r],enumerable:!0})};var N=typeof window>"u"&&typeof globalThis.WebSocketPair>"u";typeof Deno>"u"&&(self.Deno={args:[],build:{arch:"x86_64"},env:{get(){}}});var k=new Map,E=0;function b(e){self.postMessage(e)}N&&(globalThis.syscall=async(e,...t)=>await new Promise((r,o)=>{E++,k.set(E,{resolve:r,reject:o}),b({type:"sys",id:E,name:e,args:t})}));function L(e,t){N&&(self.addEventListener("message",r=>{(async()=>{let o=r.data;switch(o.type){case"inv":{let s=e[o.name];if(!s)throw new Error(`Function not loaded: ${o.name}`);try{let i=await Promise.resolve(s(...o.args||[]));b({type:"invr",id:o.id,result:i})}catch(i){console.error("An exception was thrown as a result of invoking function",o.name,"error:",i.message),b({type:"invr",id:o.id,error:i.message})}}break;case"sysr":{let s=o.id,i=k.get(s);if(!i)throw Error("Invalid request id");k.delete(s),o.error?i.reject(new Error(o.error)):i.resolve(o.result)}break}})().catch(console.error)}),b({type:"manifest",manifest:t}))}function Z(e){let t=atob(e),r=t.length,o=new Uint8Array(r);for(let s=0;s<r;s++)o[s]=t.charCodeAt(s);return o}function D(e){typeof e=="string"&&(e=new TextEncoder().encode(e));let t="",r=e.byteLength;for(let o=0;o<r;o++)t+=String.fromCharCode(e[o]);return btoa(t)}async function ee(e,t){if(typeof e!="string"){let r=new Uint8Array(await e.arrayBuffer()),o=r.length>0?D(r):void 0;t={method:e.method,headers:Object.fromEntries(e.headers.entries()),base64Body:o},e=e.url}return syscall("sandboxFetch.fetch",e,t)}globalThis.nativeFetch=globalThis.fetch;function te(){globalThis.fetch=async function(e,t){let r=t&&t.body?D(new Uint8Array(await new Response(t.body).arrayBuffer())):void 0,o=await ee(e,t&&{method:t.method,headers:t.headers,base64Body:r});return new Response(o.base64Body?Z(o.base64Body):null,{status:o.status,headers:o.headers})}}N&&te();var g={};f(g,{confirm:()=>ke,dispatch:()=>Ce,downloadFile:()=>xe,filterBox:()=>we,flashNotification:()=>be,fold:()=>Oe,foldAll:()=>je,getCurrentPage:()=>re,getCursor:()=>se,getSelection:()=>ae,getText:()=>oe,getUiOption:()=>Ne,goHistory:()=>ye,hidePanel:()=>ve,insertAtCursor:()=>Me,insertAtPos:()=>Fe,moveCursor:()=>Ae,navigate:()=>ue,openCommandPalette:()=>me,openPageNavigator:()=>de,openSearchPanel:()=>De,openUrl:()=>he,prompt:()=>Ee,reloadPage:()=>fe,reloadSettingsAndCommands:()=>ge,reloadUI:()=>pe,replaceRange:()=>Se,save:()=>ce,setPage:()=>ne,setSelection:()=>le,setText:()=>ie,setUiOption:()=>Ue,showPanel:()=>Te,toggleFold:()=>Ke,unfold:()=>Re,unfoldAll:()=>Le,uploadFile:()=>Pe,vimEx:()=>$e});typeof self>"u"&&(self={syscall:()=>{throw new Error("Not implemented here")}});var n=self.syscall;function re(){return n("editor.getCurrentPage")}function ne(e){return n("editor.setPage",e)}function oe(){return n("editor.getText")}function ie(e){return n("editor.setText",e)}function se(){return n("editor.getCursor")}function ae(){return n("editor.getSelection")}function le(e,t){return n("editor.setSelection",e,t)}function ce(){return n("editor.save")}function ue(e,t=!1,r=!1){return n("editor.navigate",e,t,r)}function de(e="page"){return n("editor.openPageNavigator",e)}function me(){return n("editor.openCommandPalette")}function fe(){return n("editor.reloadPage")}function pe(){return n("editor.reloadUI")}function ge(){return n("editor.reloadSettingsAndCommands")}function he(e,t=!1){return n("editor.openUrl",e,t)}function ye(e){return n("editor.goHistory",e)}function xe(e,t){return n("editor.downloadFile",e,t)}function Pe(e,t){return n("editor.uploadFile",e,t)}function be(e,t="info"){return n("editor.flashNotification",e,t)}function we(e,t,r="",o=""){return n("editor.filterBox",e,t,r,o)}function Te(e,t,r,o=""){return n("editor.showPanel",e,t,r,o)}function ve(e){return n("editor.hidePanel",e)}function Fe(e,t){return n("editor.insertAtPos",e,t)}function Se(e,t,r){return n("editor.replaceRange",e,t,r)}function Ae(e,t=!1){return n("editor.moveCursor",e,t)}function Me(e){return n("editor.insertAtCursor",e)}function Ce(e){return n("editor.dispatch",e)}function Ee(e,t=""){return n("editor.prompt",e,t)}function ke(e){return n("editor.confirm",e)}function Ne(e){return n("editor.getUiOption",e)}function Ue(e,t){return n("editor.setUiOption",e,t)}function $e(e){return n("editor.vimEx",e)}function Oe(){return n("editor.fold")}function Re(){return n("editor.unfold")}function Ke(){return n("editor.toggleFold")}function je(){return n("editor.foldAll")}function Le(){return n("editor.unfoldAll")}function De(){return n("editor.openSearchPanel")}var h={};f(h,{parseMarkdown:()=>Be});function Be(e){return n("markdown.parseMarkdown",e)}var l={};f(l,{deleteAttachment:()=>_e,deleteFile:()=>rt,deletePage:()=>Ge,getAttachmentMeta:()=>Ye,getFileMeta:()=>et,getPageMeta:()=>We,listAttachments:()=>He,listFiles:()=>Je,listPages:()=>Ve,listPlugs:()=>Qe,readAttachment:()=>ze,readFile:()=>Ze,readPage:()=>qe,writeAttachment:()=>Xe,writeFile:()=>tt,writePage:()=>Ie});function Ve(e=!1){return n("space.listPages",e)}function We(e){return n("space.getPageMeta",e)}function qe(e){return n("space.readPage",e)}function Ie(e,t){return n("space.writePage",e,t)}function Ge(e){return n("space.deletePage",e)}function Qe(){return n("space.listPlugs")}function He(){return n("space.listAttachments")}function Ye(e){return n("space.getAttachmentMeta",e)}function ze(e){return n("space.readAttachment",e)}function Xe(e,t){return n("space.writeAttachment",e,t)}function _e(e){return n("space.deleteAttachment",e)}function Je(){return n("space.listFiles")}function Ze(e){return n("space.readFile",e)}function et(e){return n("space.getFileMeta",e)}function tt(e,t){return n("space.writeFile",e,t)}function rt(e){return n("space.deleteFile",e)}var x={};f(x,{getEnv:()=>at,getMode:()=>lt,invokeCommand:()=>nt,invokeFunction:()=>U,listCommands:()=>ot,listSyscalls:()=>it,reloadPlugs:()=>st});function U(e,...t){return n("system.invokeFunction",e,...t)}function nt(e,t){return n("system.invokeCommand",e,t)}function ot(){return n("system.listCommands")}function it(){return n("system.listSyscalls")}function st(){n("system.reloadPlugs")}function at(){return n("system.getEnv")}function lt(){return n("system.getMode")}var w={};f(w,{hasInitialSyncCompleted:()=>dt,isSyncing:()=>ut,scheduleFileSync:()=>mt,scheduleSpaceSync:()=>ft});function ut(){return n("sync.isSyncing")}function dt(){return n("sync.hasInitialSyncCompleted")}function mt(e){return n("sync.scheduleFileSync",e)}function ft(){return n("sync.scheduleSpaceSync")}var T={};f(T,{parseTemplate:()=>yt,renderTemplate:()=>ht});function ht(e,t,r={}){return n("template.renderTemplate",e,t,r)}function yt(e){return n("template.parseTemplate",e)}var d=globalThis.syscall;var P={};f(P,{parse:()=>Tt,stringify:()=>vt});function Tt(e){return d("yaml.parse",e)}function vt(e){return d("yaml.stringify",e)}function B(e,t){return v(e,r=>r.type===t)}function v(e,t){if(t(e))return[e];let r=[];if(e.children)for(let o of e.children)r=[...r,...v(o,t)];return r}function $(e,t){if(e.children){let r=e.children.slice();for(let o of r){let s=t(o);if(s!==void 0){let i=e.children.indexOf(o);s?e.children.splice(i,1,s):e.children.splice(i,1)}else $(o,t)}}}function O(e,t){return v(e,r=>r.type===t)[0]}function V(e,t){v(e,t)}function R(e){if(!e)return"";let t=[];if(e.text!==void 0)return e.text;for(let r of e.children)t.push(R(r));return t.join("")}async function K(e,t){let r=await l.readPage(e),o=await h.parseMarkdown(r),s;return V(o,i=>{if(i.type!=="FencedCode")return!1;let c=O(i,"CodeInfo");if(t&&!c||t&&!t.includes(c.children[0].text))return!1;let m=O(i,"CodeText");return m?(s=m.children[0].text,!0):!1}),s}async function F(e,t=["yaml"]){let r=await K(e,t);if(r!==void 0)try{return P.parse(r)}catch(o){throw console.error("YAML Page parser error",o),new Error(`YAML Error: ${o.message}`)}}async function W(e){try{let r=(await F("SECRETS",["yaml","secrets"]))[e];if(r===void 0)throw new Error(`No such secret: ${e}`);return r}catch(t){throw t.message==="Not found"?new Error(`No such secret: ${e}`):t}}var At="SETTINGS";async function q(e,t){try{let o=(await F(At,["yaml"])||{})[e];return o===void 0?t:o}catch(r){if(r.message==="Not found")return t;throw r}}var S=class{constructor(t,r={}){this.maxSize=t;this.map=new Map(Object.entries(r))}map;set(t,r,o){let s={value:r,la:Date.now()};if(o){let i=this.map.get(t);i?.expTimer&&clearTimeout(i.expTimer),s.expTimer=setTimeout(()=>{this.map.delete(t)},o)}if(this.map.size>=this.maxSize){let i=this.getOldestKey();this.map.delete(i)}this.map.set(t,s)}get(t){let r=this.map.get(t);if(r)return r.la=Date.now(),r.value}remove(t){this.map.delete(t)}toJSON(){return Object.fromEntries(this.map.entries())}getOldestKey(){let t,r;for(let[o,s]of this.map.entries())(!r||s.la<r)&&(t=o,r=s.la);return t}};var I=new S(50);async function G(e,t,r){if(!r)return t(e);let o=JSON.stringify(e),s=I.get(o);if(s)return s;let i=await t(e);return I.set(o,i,r*1e3),i}function Q(e,t,r){return G(t,()=>U("index.queryObjects",e,t),r)}var A=class{constructor(t){this.prefix=t}async listFiles(){return(await l.listFiles()).filter(t=>t.name.startsWith(this.prefix)).map(t=>({...t,name:t.name.slice(this.prefix.length)}))}readFile(t){return l.readFile(this.prefix+t)}getFileMeta(t){return l.getFileMeta(this.prefix+t)}writeFile(t,r){return l.writeFile(this.prefix+t,r)}deleteFile(t){return l.deleteFile(this.prefix+t)}};var M=class{constructor(t,r){this.url=t;this.token=r}authenticatedFetch(t,r){return nativeFetch(t,{...r,headers:{...r?.headers,"X-Sync-Mode":"true",Authorization:`Bearer ${this.token}`}})}async listFiles(){let t=await this.authenticatedFetch(`${this.url}/index.json`,{method:"GET"});if(t.status===404)throw new Error("Not found");return t.json()}async readFile(t){let r=await this.authenticatedFetch(`${this.url}/${t}`,{method:"GET"});return new Uint8Array(await r.arrayBuffer())}async getFileMeta(t){let r=await this.authenticatedFetch(`${this.url}/${t}`,{method:"GET",headers:{"X-Get-Meta":"true"}});return this.headersToFileMeta(t,r.headers)}async writeFile(t,r){let o=await this.authenticatedFetch(`${this.url}/${t}`,{method:"PUT",body:r});if(o.ok)return this.headersToFileMeta(t,o.headers);throw new Error(`Failed to write file: ${await o.text()}`)}async deleteFile(t){let r=await this.authenticatedFetch(`${this.url}/${t}`,{method:"DELETE"});if(!r.ok)throw new Error(`Failed to delete file: ${t}: ${await r.text()}`)}headersToFileMeta(t,r){return{name:t,contentType:r.get("Content-Type")||"application/octet-stream",perm:r.get("X-Perm"),created:+(r.get("X-Created")||"0"),lastModified:+(r.get("X-Last-Modified")||"0"),size:r.has("X-Content-Length")?+r.get("X-Content-Length"):+r.get("Content-Length")}}};var H={removeHashtags:!0,template:"!pub.silverbullet.md/template/page",destPrefix:"_public/"};async function Y(e,t,r,o,s,i,c){console.log("Writing",t);let m=await l.readPage(t),p=await h.parseMarkdown(m),y=await Et(p,i,s,t),a=Ct(p);for(let u of a)try{let C=await l.readAttachment(u);console.log("Writing",u),await e.writeFile(u,C)}catch(C){console.error("Error reading attachment",u,C.message)}await e.writeFile(o,new TextEncoder().encode(y)),await e.writeFile(r,new TextEncoder().encode(await T.renderTemplate(c,{pageName:t,config:i,isIndex:t===i.indexPage,body:await x.invokeFunction("markdown.markdownToHtml",y,{smartHardBreak:!0,attachmentUrlPrefix:"/"})},{})))}async function j(){let e=H;try{let a=await q("publish",{});if(e={...H,...a},e.publishServer)try{let u=await W("publish");e.publishToken=u.token}catch(u){console.error("No publish secret found",u)}}catch(a){console.warn("No SETTINGS page found, using defaults",a.message)}let t=e.destPrefix;if(e.publishServer&&!e.publishToken)throw new Error("publishServer specified, but no matching 'token' under 'publish' found in SECRETS");let r=e.publishServer?new M(e.publishServer,e.publishToken):new A(t);console.log("Publishing to",r);let o=await Q("page",{});console.log("All pages",o);let s=new Map(o.map(a=>[a.name,a]));s.delete("SECRETS"),console.log("Cleaning up destination directory");let i=[];try{i=await r.listFiles()}catch(a){a.message==="Not found"&&console.log("Could not fetch file list from remote, assume it has not been initialized yet")}for(let a of i)await r.deleteFile(a.name);o=[...s.values()];let c=new Set;if(e.publishAll)c=new Set(o.map(a=>a.name));else for(let a of o){if(e.tags&&a.tags)for(let u of a.tags)e.tags.includes(u)&&c.add(a.name);if(typeof a.name=="string"){if(e.prefixes)for(let u of e.prefixes)a.name.startsWith(u)&&c.add(a.name);a.$share&&(Array.isArray(a.$share)||(a.$share=[a.$share]),a.$share.includes("pub")&&c.add(a.name))}}console.log("Publishing",[...c]);let m=await K(e.template),p=[...c];for(let a of p)await Y(r,a,`${a}/index.html`,`${a}.md`,p,e,m);console.log("Done writing published paegs"),e.indexPage&&(console.log("Writing index page",e.indexPage),await Y(r,e.indexPage,"index.html","index.md",p,e,m)),console.log("Publishing index.json");let y=[];for(let a of await r.listFiles())a.contentType!=="text/html"&&y.push({...a,perm:"ro"});await r.writeFile("index.json",new TextEncoder().encode(JSON.stringify(y,null,2)))}async function z(){await g.flashNotification("Publishing..."),await j(),await w.scheduleSpaceSync(),await g.flashNotification("Done!")}function Ct(e){let t=[];return B(e,"URL").forEach(r=>{let o=r.children[0].text;o.indexOf("://")===-1&&t.push(o)}),t}async function Et(e,t,r,o){try{e=await x.invokeFunction("markdown.expandCodeWidgets",e,o)}catch(s){console.error("Error expanding code widgets in page",o,s.message)}return $(e,s=>{if(s.type==="WikiLink"){let i=s.children[1].children[0].text;if(i.includes("@")&&(i=i.split("@")[0]),i.startsWith("!"))return{text:`[${i.split("/").pop()}](https://${i.slice(1)})`};if(!r.includes(i)&&!i.startsWith("!"))return{text:`_${i}_`}}if(s.type==="CommentBlock"||s.type==="Comment"||s.type==="Hashtag"&&t.removeHashtags)return null}),R(e).trim()}var X={publishAll:j,publishAllCommand:z},_={name:"pub",functions:{publishAll:{path:"./publish.ts:publishAll"},publishAllCommand:{path:"./publish.ts:publishAllCommand",command:{name:"Pub: Publish All"}}},assets:{}},Kr={manifest:_,functionMapping:X};L(X,_);export{Kr as plug};
